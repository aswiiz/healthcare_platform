{% extends "base.html" %}

{% block title %}Patient Dashboard - Healthcare Hub{% endblock %}

{% block content %}
<div class="hero">
    <h1>Hello, {{ username }}</h1>
    <p>Welcome to your health command center. Monitor your vital stats, track your daily wellness, and consult our AI
        engine.</p>
</div>

<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; width: 100%; max-width: 1200px;">
    <!-- AI Diagnostic Card -->
    <div class="card" style="display: flex; flex-direction: column; border-top: 5px solid var(--primary-blue);">
        <div style="margin-bottom: 1.5rem; color: var(--primary-blue);">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
            </svg>
        </div>
        <h3 style="margin-bottom: 0.5rem;">AI Health Analysis</h3>
        <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 2rem; flex-grow: 1;">
            {% if has_data %}
            Your latest assessment is ready. View your risk profiles and personalized recommendations.
            {% else %}
            Start your first AI diagnostic session to understand your health risks and get improvements.
            {% endif %}
        </p>
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            {% if has_data %}
            <a href="{{ url_for('health_report') }}" class="btn">View Latest Analysis</a>
            <a href="{{ url_for('health_data') }}" class="btn btn-secondary">Run New Assessment</a>
            {% else %}
            <a href="{{ url_for('health_data') }}" class="btn">Start Assessment</a>
            {% endif %}
        </div>
    </div>

    <!-- Health Diary Card -->
    <div class="card" style="display: flex; flex-direction: column; border-top: 5px solid var(--primary-green);">
        <div style="margin-bottom: 1.5rem; color: var(--primary-green);">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
            </svg>
        </div>
        <h3 style="margin-bottom: 0.5rem;">Daily Wellness Diary</h3>
        <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 2rem; flex-grow: 1;">
            Log your daily mood, sleep, water intake, and symptoms to build a comprehensive health timeline.
        </p>
        <a href="{{ url_for('health_diary') }}" class="btn" style="background: var(--primary-green);">Open Health
            Diary</a>
    </div>

    <!-- Records Card -->
    <div class="card" style="display: flex; flex-direction: column; border-top: 5px solid var(--dark-blue);">
        <div style="margin-bottom: 1.5rem; color: var(--dark-blue);">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" y1="13" x2="8" y2="13" />
                <line x1="16" y1="17" x2="8" y2="17" />
                <polyline points="10 9 9 9 8 9" />
            </svg>
        </div>
        <h3 style="margin-bottom: 0.5rem;">Medical Records</h3>
        <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 2rem; flex-grow: 1;">
            Access your full history of clinical treatments, lab results, and previous AI diagnostics in one place.
        </p>
        <a href="{{ url_for('medical_records') }}" class="btn" style="background: var(--dark-blue);">Access Records</a>
    </div>

    <!-- Knowledge Base Card -->
    <div class="card" style="display: flex; flex-direction: column; border-top: 5px solid #6366f1;">
        <div style="margin-bottom: 1.5rem; color: #6366f1;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="16" x2="12" y2="12" />
                <line x1="12" y1="8" x2="12.01" y2="8" />
            </svg>
        </div>
        <h3 style="margin-bottom: 0.5rem;">Health Education</h3>
        <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 2rem; flex-grow: 1;">
            Learn about preventative care, first aid essentials, and lifestyle tips for optimal wellbeing.
        </p>
        <a href="{{ url_for('disease_info') }}" class="btn" style="background: #6366f1;">Browse Knowledge</a>
    </div>
</div>

<!-- Chatbot Integration -->
<div id="chatbot-container" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000; width: 350px;">
    <div id="chatbot-window"
        style="display: none; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #e2e8f0; flex-direction: column; height: 500px; overflow: hidden;">
        <div
            style="background: var(--dark-blue); color: white; padding: 1.25rem; font-weight: 700; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 10px; height: 10px; background: #4ade80; border-radius: 50%;"></div>
                Health Assistant
            </div>
            <button onclick="toggleChatbot()"
                style="background: none; border: none; color: white; cursor: pointer; font-size: 1.5rem;">&times;</button>
        </div>
        <div id="chatbot-messages"
            style="flex-grow: 1; overflow-y: auto; padding: 1.25rem; display: flex; flex-direction: column; gap: 1rem; background: #f8fafc;">
            <div
                style="background: white; padding: 0.75rem 1rem; border-radius: 12px 12px 12px 0; border: 1px solid #e2e8f0; align-self: flex-start; max-width: 85%; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                Hi {{ username }}! I'm your virtual health assistant. How can I help you today?
            </div>
        </div>
        <div style="padding: 1.25rem; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 0.75rem;">
            <input type="text" id="chatbot-input" placeholder="Type health question..."
                style="flex-grow: 1; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 0.9rem; outline: none; transition: border-color 0.2s;"
                onfocus="this.style.borderColor='var(--primary-blue)'" onblur="this.style.borderColor='#e2e8f0'">
            <button onclick="sendMessage()" class="btn"
                style="padding: 0; width: 45px; height: 45px; border-radius: 12px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13" />
                    <polygon points="22 2 15 22 11 13 2 9 22 2" />
                </svg>
            </button>
        </div>
    </div>
    <button id="chatbot-toggle" onclick="toggleChatbot()"
        style="background: var(--primary-blue); color: white; border: none; border-radius: 50%; width: 65px; height: 65px; cursor: pointer; box-shadow: 0 8px 25px rgba(14, 165, 233, 0.4); display: flex; align-items: center; justify-content: center; float: right; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <svg id="chat-icon" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
        </svg>
    </button>
</div>

<script>
    function toggleChatbot() {
        const window = document.getElementById('chatbot-window');
        const toggle = document.getElementById('chatbot-toggle');
        const isOpen = window.style.display === 'flex';

        window.style.display = isOpen ? 'none' : 'flex';
        toggle.style.transform = isOpen ? 'scale(1)' : 'scale(0.9) rotate(90deg)';
    }

    async function sendMessage() {
        const input = document.getElementById('chatbot-input');
        const msg = input.value.trim();
        if (!msg) return;

        const messages = document.getElementById('chatbot-messages');

        // User message
        const userDiv = document.createElement('div');
        userDiv.style.cssText = "background: var(--primary-blue); color: white; padding: 0.75rem 1rem; border-radius: 12px 12px 0 12px; align-self: flex-end; max-width: 85%; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.2);";
        userDiv.textContent = msg;
        messages.appendChild(userDiv);

        input.value = '';
        messages.scrollTop = messages.scrollHeight;

        try {
            const response = await fetch('/api/chatbot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            });
            const data = await response.json();

            const botDiv = document.createElement('div');
            botDiv.style.cssText = "background: white; padding: 0.75rem 1rem; border-radius: 12px 12px 12px 0; border: 1px solid #e2e8f0; align-self: flex-start; max-width: 85%; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02);";
            botDiv.textContent = data.reply;
            messages.appendChild(botDiv);
            messages.scrollTop = messages.scrollHeight;
        } catch (e) {
            console.error(e);
        }
    }

    document.getElementById('chatbot-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });
</script>
{% endblock %}